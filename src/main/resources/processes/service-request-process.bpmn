<?xml version="1.0" encoding="UTF-8"?>
    <definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
                 xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                 xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                 xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                 xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
                 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 id="Definitions_1"
                 targetNamespace="http://bpmn.io/schema/bpmn">

      <process id="service-request-process"
               name="External Service Procurement V1"
               isExecutable="true"
               camunda:historyTimeToLive="P180D">

        <!-- ================================================= -->
        <!-- START -->
        <!-- ================================================= -->
        <startEvent id="StartEvent_1" name="Request Received (1B)">
          <outgoing>Flow_1</outgoing>
        </startEvent>

        <sequenceFlow id="Flow_1"
                      sourceRef="StartEvent_1"
                      targetRef="Activity_CheckContract"/>

        <!-- ================================================= -->
        <!-- CONTRACT VALIDATION -->
        <!-- ================================================= -->
        <serviceTask id="Activity_CheckContract"
                     name="Validate Contract"
                     camunda:delegateExpression="${checkContractDelegate}">
          <outgoing>Flow_Check_Result</outgoing>
        </serviceTask>

        <sequenceFlow id="Flow_Check_Result"
                      sourceRef="Activity_CheckContract"
                      targetRef="Gateway_Contract_Valid"/>

        <exclusiveGateway id="Gateway_Contract_Valid"
                          name="Contract Valid?"/>

        <!--  Contract Invalid -->
        <sequenceFlow id="Flow_Contract_Invalid"
                      sourceRef="Gateway_Contract_Valid"
                      targetRef="Activity_Notify_Contract_Rejection">
          <conditionExpression xsi:type="tFormalExpression">
            ${contractValid == false}
          </conditionExpression>
        </sequenceFlow>

        <serviceTask id="Activity_Notify_Contract_Rejection"
                     name="Notify 1B (Contract Missing)"
                     camunda:delegateExpression="${notifyContractRejectionDelegate}">
          <outgoing>Flow_End_Contract_Fail</outgoing>
        </serviceTask>

        <endEvent id="Flow_End_Contract_Fail"
                  name="Process Terminated (No Contract)"/>

        <!--  Contract Valid -->
        <sequenceFlow id="Flow_Contract_Valid"
                      sourceRef="Gateway_Contract_Valid"
                      targetRef="Activity_PO_Approval">
          <conditionExpression xsi:type="tFormalExpression">
            ${contractValid == true}
          </conditionExpression>
        </sequenceFlow>

        <!-- ================================================= -->
        <!-- PO APPROVAL -->
        <!-- ================================================= -->
        <userTask id="Activity_PO_Approval"
                  name="Approve Request (PO)"
                  camunda:assignee="po_user">
          <incoming>Flow_Contract_Valid</incoming>
          <incoming>Flow_RejectionFix</incoming>
          <outgoing>Flow_PO_Decision</outgoing>
        </userTask>

        <sequenceFlow id="Flow_PO_Decision"
                      sourceRef="Activity_PO_Approval"
                      targetRef="Gateway_Approved"/>

        <exclusiveGateway id="Gateway_Approved"
                          name="Approved?"/>

        <!-- ❌ PO Reject -->
        <sequenceFlow id="Flow_PO_Reject"
                      sourceRef="Gateway_Approved"
                      targetRef="Activity_PM_Fix">
          <conditionExpression xsi:type="tFormalExpression">
            ${approved == false}
          </conditionExpression>
        </sequenceFlow>

        <!-- ✅ PO Approve -->
        <sequenceFlow id="Flow_PO_Approve"
                      sourceRef="Gateway_Approved"
                      targetRef="Activity_Publish">
          <conditionExpression xsi:type="tFormalExpression">
            ${approved == true}
          </conditionExpression>
        </sequenceFlow>

        <!-- ================================================= -->
        <!-- PM FIX LOOP -->
        <!-- ================================================= -->
        <userTask id="Activity_PM_Fix"
                  name="Fix Request (PM)"
                  camunda:assignee="pm_user">
          <outgoing>Flow_RejectionFix</outgoing>
        </userTask>

        <sequenceFlow id="Flow_RejectionFix"
                      sourceRef="Activity_PM_Fix"
                      targetRef="Activity_PO_Approval"/>

        <!-- ================================================= -->
        <!-- PUBLISH & EVALUATION -->
        <!-- ================================================= -->
        <serviceTask id="Activity_Publish"
                     name="Publish to Providers"
                     camunda:delegateExpression="${publishToProvidersDelegate}">
          <outgoing>Flow_To_PM_Evaluate</outgoing>
        </serviceTask>

        <sequenceFlow id="Flow_To_PM_Evaluate"
                      sourceRef="Activity_Publish"
                      targetRef="Activity_PM_Evaluate"/>

        <userTask id="Activity_PM_Evaluate"
                  name="Evaluate Offers (PM)"
                  camunda:assignee="pm_user">
          <outgoing>Flow_To_PO_Validate</outgoing>
        </userTask>

        <sequenceFlow id="Flow_To_PO_Validate"
                      sourceRef="Activity_PM_Evaluate"
                      targetRef="Activity_PO_Validate"/>

        <userTask id="Activity_PO_Validate"
                  name="Validate Selection (PO)"
                  camunda:assignee="po_user">
          <outgoing>Flow_Gateway_Selection</outgoing>
        </userTask>

        <sequenceFlow id="Flow_Gateway_Selection"
                      sourceRef="Activity_PO_Validate"
                      targetRef="Gateway_Selection_Approved"/>

        <exclusiveGateway id="Gateway_Selection_Approved"
                          name="Selection Valid?"/>

        <!-- ❌ Selection Rejected -->
        <sequenceFlow id="Flow_Selection_Reject"
                      sourceRef="Gateway_Selection_Approved"
                      targetRef="Activity_PM_Evaluate">
          <conditionExpression xsi:type="tFormalExpression">
            ${selectionApproved == false}
          </conditionExpression>
        </sequenceFlow>

        <!-- ✅ Selection Approved -->
        <sequenceFlow id="Flow_Selection_OK"
                      sourceRef="Gateway_Selection_Approved"
                      targetRef="Activity_Notify_1b">
          <conditionExpression xsi:type="tFormalExpression">
            ${selectionApproved == true}
          </conditionExpression>
        </sequenceFlow>

        <!-- ================================================= -->
        <!-- 1B DECISION -->
        <!-- ================================================= -->
        <serviceTask id="Activity_Notify_1b"
                     name="Send Recommendation to 1B"
                     camunda:delegateExpression="${notify1bRecommendationDelegate}">
          <outgoing>Flow_Wait_1b</outgoing>
        </serviceTask>

        <sequenceFlow id="Flow_Wait_1b"
                      sourceRef="Activity_Notify_1b"
                      targetRef="Event_Wait_1b"/>

        <receiveTask id="Event_Wait_1b"
                     name="Wait for 1B Decision"
                     messageRef="Message_1b_Decision"
                     camunda:asyncBefore="true">
          <outgoing>Flow_After_Wait</outgoing>
        </receiveTask>

        <sequenceFlow id="Flow_After_Wait"
                      sourceRef="Event_Wait_1b"
                      targetRef="Gateway_1b_Decision"/>

        <exclusiveGateway id="Gateway_1b_Decision"
                          name="1B Decision?"/>

        <!-- ❌ 1B Reject -->
        <sequenceFlow id="Flow_1b_Reject"
                      sourceRef="Gateway_1b_Decision"
                      targetRef="Activity_Notify_4b_Reject">
          <conditionExpression xsi:type="tFormalExpression">
            ${oneBDecision == 'REJECTED'}
          </conditionExpression>
        </sequenceFlow>

        <serviceTask id="Activity_Notify_4b_Reject"
                     name="Notify Provider (Rejected)"
                     camunda:delegateExpression="${notifyProviderRejectDelegate}">
          <outgoing>Flow_End_Reject</outgoing>
        </serviceTask>

        <endEvent id="Flow_End_Reject"
                  name="Request Rejected by 1B"/>

        <!-- ✅ 1B Accept -->
        <sequenceFlow id="Flow_1b_Accept"
                      sourceRef="Gateway_1b_Decision"
                      targetRef="Activity_RP_Coordination">
          <conditionExpression xsi:type="tFormalExpression">
            ${oneBDecision == 'ACCEPTED'}
          </conditionExpression>
        </sequenceFlow>

        <!-- ================================================= -->
        <!-- ORDER CREATION -->
        <!-- ================================================= -->
        <userTask id="Activity_RP_Coordination"
                  name="Confirm Logistics (RP)"
                  camunda:assignee="rp_user">
          <outgoing>Flow_To_CreateOrder</outgoing>
        </userTask>

        <sequenceFlow id="Flow_To_CreateOrder"
                      sourceRef="Activity_RP_Coordination"
                      targetRef="Activity_CreateOrder"/>

        <serviceTask id="Activity_CreateOrder"
                     name="Create Service Order"
                     camunda:delegateExpression="${createServiceOrderDelegate}">
          <outgoing>Flow_To_Notify_Win</outgoing>
        </serviceTask>

        <sequenceFlow id="Flow_To_Notify_Win"
                      sourceRef="Activity_CreateOrder"
                      targetRef="Activity_Notify_Win"/>

        <serviceTask id="Activity_Notify_Win"
                     name="Notify Provider (Win)"
                     camunda:delegateExpression="${notifyProviderDelegate}">
          <outgoing>Flow_To_Workforce</outgoing>
        </serviceTask>

        <sequenceFlow id="Flow_To_Workforce"
                      sourceRef="Activity_Notify_Win"
                      targetRef="Activity_NotifyWorkforce"/>

        <serviceTask id="Activity_NotifyWorkforce"
                     name="Update Workforce System"
                     camunda:delegateExpression="${notifyWorkforceDelegate}">
          <outgoing>Flow_End</outgoing>
        </serviceTask>

        <endEvent id="Flow_End"
                  name="Service Order Active"/>

      </process>

      <message id="Message_1b_Decision"
               name="Message_1b_Decision"/>

    </definitions>